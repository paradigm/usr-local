#!/usr/bin/awk -f
BEGIN{
	"date +%Y" | getline current_year;
	close("date +%Y")
	"date +%m" | getline current_month;
	close("date +%m")
	"date +%d" | getline current_day;
	close("date +%d")
	output=""
	"uname -n" | getline hostname
	if(hostname = "am"){
		output_length = 150
		max_item_count = 4
	} else {
		output_length = 300
		max_item_count = 6
	}
	get_section_count = "grep -c '^\[' "ARGV[1]
	get_section_count | getline section_count;
	close(get_section_count)
	items_per_section = int(max_item_count / section_count)
}

/^\[/{
	used_section=0
	section=substr($0,2,length($0)-2)
}
! /^\[/ && ! /^#/ && ! /^$/ && used_section < items_per_section{
	used_section += 1
	item_year = substr($0,1,4)
	item_month = substr($0,6,2)
	item_day = substr($0,9,2)
	days = 0
	days += (item_year - current_year)*365
	month = current_month
	while(month+0 != item_month+0){
		month+=1
		if(month==13){
			month=1
			days-=365
		}
		if(month == 1)
			days += 31
		if(month == 2)
			days += 29
		if(month == 3)
			days += 31
		if(month == 4)
			days += 30
		if(month == 5)
			days += 31
		if(month == 6)
			days += 30
		if(month == 7)
			days += 31
		if(month == 8)
			days += 31
		if(month == 9)
			days += 30
		if(month == 10)
			days += 31
		if(month == 11)
			days += 30
		if(month == 12)
			days += 31
	}
	days += (item_day - current_day)
	get_day_of_week="date --date="$1" +%w"
	get_day_of_week | getline day_of_week
	if(day_of_week == 0)
		day_of_week = "S"
	else if(day_of_week == 1)
		day_of_week = "M"
	else if(day_of_week == 2)
		day_of_week = "T"
	else if(day_of_week == 3)
		day_of_week = "W"
	else if(day_of_week == 4)
		day_of_week = "R"
	else if(day_of_week == 5)
		day_of_week = "F"
	else if(day_of_week == 6)
		day_of_week = "T"
	close(get_day_of_week)
	output = output  substr($0,12) " "days""day_of_week""item_month""item_day"  "
}
END{
	printf substr(output,1,output_length)
}
